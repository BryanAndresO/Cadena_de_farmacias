# Docker Compose configuration for Pharmacy Chain Microservices
# Includes: Databases, OAuth2 Server, API Gateway, Microservices, and Frontend

services:
  # ==================== DATABASES ====================

  auth-db:
    image: postgres:15
    container_name: postgres-auth
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
    ports:
      - "5433:5432"
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
    networks:
      - red-microservicios
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  catalogo-db:
    image: mysql:8.0
    container_name: mysql-catalogo
    environment:
      MYSQL_DATABASE: catalogodb
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
      MYSQL_USER: AppRoot
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
    ports:
      - "3309:3306"
    volumes:
      - mysql_catalogo_data:/var/lib/mysql
    networks:
      - red-microservicios
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  sucursal-db:
    image: mysql:8.0
    container_name: mysql-sucursal
    environment:
      MYSQL_DATABASE: sucursalesdb
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
      MYSQL_USER: AppRoot
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
    ports:
      - "3310:3306"
    volumes:
      - mysql_sucursal_data:/var/lib/mysql
    networks:
      - red-microservicios
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  cliente-db:
    image: mysql:8.0
    container_name: mysql-cliente
    environment:
      MYSQL_DATABASE: clientesdb
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
      MYSQL_USER: AppRoot
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
    ports:
      - "3311:3306"
    volumes:
      - mysql_cliente_data:/var/lib/mysql
    networks:
      - red-microservicios
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  ventas-db:
    image: mysql:8.0
    container_name: mysql-ventas
    environment:
      MYSQL_DATABASE: ventasdb
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
      MYSQL_USER: AppRoot
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
    ports:
      - "3312:3306"
    volumes:
      - mysql_ventas_data:/var/lib/mysql
    networks:
      - red-microservicios
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  reporte-db:
    image: mysql:8.0
    container_name: mysql-reporte
    environment:
      MYSQL_DATABASE: reportesdb
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
      MYSQL_USER: AppRoot
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
    ports:
      - "3313:3306"
    volumes:
      - mysql_reporte_data:/var/lib/mysql
    networks:
      - red-microservicios
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  inventario-db:
    image: mysql:8.0
    container_name: mysql-inventario
    environment:
      MYSQL_DATABASE: inventariodb
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
      MYSQL_USER: AppRoot
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme} # SEC-007 FIX
    ports:
      - "3314:3306"
    volumes:
      - mysql_inventario_data:/var/lib/mysql
    networks:
      - red-microservicios
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== MICROSERVICES ====================

  micro-catalogo:
    build:
      context: ./micro_Catalogo
      dockerfile: Dockerfile
    container_name: micro-catalogo
    ports:
      - "8081:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://catalogo-db:3306/catalogodb?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: AppRoot
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-changeme}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://oauth-server:9000/oauth2/jwks
    depends_on:
      catalogo-db:
        condition: service_healthy
      oauth-server:
        condition: service_started
    networks:
      - red-microservicios
    restart: on-failure

  micro-sucursal:
    build:
      context: ./micro_Sucursal
      dockerfile: Dockerfile
    container_name: micro-sucursal
    ports:
      - "8082:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://sucursal-db:3306/sucursalesdb?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: AppRoot
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-changeme}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://oauth-server:9000/oauth2/jwks
    depends_on:
      sucursal-db:
        condition: service_healthy
      oauth-server:
        condition: service_started
    networks:
      - red-microservicios
    restart: on-failure

  micro-cliente:
    build:
      context: ./micro_Cliente
      dockerfile: Dockerfile
    container_name: micro-cliente
    ports:
      - "8083:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://cliente-db:3306/clientesdb?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: AppRoot
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-changeme}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://oauth-server:9000/oauth2/jwks
    depends_on:
      cliente-db:
        condition: service_healthy
      oauth-server:
        condition: service_started
    networks:
      - red-microservicios
    restart: on-failure

  micro-ventas:
    build:
      context: ./micro_Ventas
      dockerfile: Dockerfile
    container_name: micro-ventas
    ports:
      - "8084:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://ventas-db:3306/ventasdb?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: AppRoot
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-changeme}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://oauth-server:9000/oauth2/jwks
    depends_on:
      ventas-db:
        condition: service_healthy
      oauth-server:
        condition: service_started
    networks:
      - red-microservicios
    restart: on-failure

  micro-reporte:
    build:
      context: ./micro_Reporte
      dockerfile: Dockerfile
    container_name: micro-reporte
    ports:
      - "8085:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://reporte-db:3306/reportesdb?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: AppRoot
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-changeme}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://oauth-server:9000/oauth2/jwks
    depends_on:
      reporte-db:
        condition: service_healthy
      oauth-server:
        condition: service_started
    networks:
      - red-microservicios
    restart: on-failure

  micro-inventario:
    build:
      context: ./micro_inventario
      dockerfile: Dockerfile
    container_name: micro-inventario
    ports:
      - "8086:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://inventario-db:3306/inventariodb?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: AppRoot
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-changeme}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://oauth-server:9000/oauth2/jwks
      CATALOGO_SERVICE_URL: http://micro-catalogo:8080
    depends_on:
      inventario-db:
        condition: service_healthy
      oauth-server:
        condition: service_started
    networks:
      - red-microservicios
    restart: on-failure

  oauth-server:
    build:
      context: ./oauth.server
      dockerfile: Dockerfile
    container_name: oauth-server
    ports:
      - "9000:9000"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://auth-db:5432/auth_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-changeme}
      # OAuth2 Issuer URI (should match public URL that clients use to access this server)
      OAUTH2_ISSUER_URI: ${OAUTH_ISSUER_URI:-http://localhost:9000}
      # OAuth2 dynamic configuration for redirect URIs
      OAUTH2_CLIENT_GATEWAY_BASE_URL: ${GATEWAY_PUBLIC_URL:-http://localhost:8080}
      OAUTH2_CLIENT_FRONTEND_BASE_URL: ${FRONTEND_PUBLIC_URL:-http://localhost:5173}
      OAUTH2_CLIENT_PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-}
      # SEC-002/003 FIX: Client secret desde .env
      OAUTH2_CLIENT_SECRET: ${OAUTH_CLIENT_SECRET}
      # SEC-001 FIX: Credenciales de usuarios desde .env (NO tienen valores por defecto)
      # IMPORTANTE: Estas variables DEBEN estar definidas en el archivo .env
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      USER_PASSWORD: ${USER_PASSWORD}
    depends_on:
      auth-db:
        condition: service_healthy
    networks:
      - red-microservicios
    restart: on-failure

  gateway:
    build:
      context: ./gateway/gateway
      dockerfile: Dockerfile
    container_name: gateway
    ports:
      - "8080:8080"
    environment:
      # OAuth2 dynamic configuration
      OAUTH_PUBLIC_URL: ${OAUTH_PUBLIC_URL:-http://localhost:9000}
      # SEC-002 FIX: Client secret desde .env
      OAUTH_CLIENT_SECRET: ${OAUTH_CLIENT_SECRET}
    depends_on:
      - oauth-server
      - micro-catalogo
      - micro-sucursal
      - micro-cliente
      - micro-ventas
      - micro-reporte
      - micro-inventario
      - frontend
    networks:
      - red-microservicios
    restart: on-failure

  # ==================== FRONTEND ====================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    # No external ports - only accessible through Gateway
    networks:
      - red-microservicios
    restart: on-failure

# ==================== NETWORKS ====================

networks:
  red-microservicios:
    driver: bridge

# ==================== VOLUMES ====================

volumes:
  postgres_auth_data:
  mysql_catalogo_data:
  mysql_sucursal_data:
  mysql_cliente_data:
  mysql_ventas_data:
  mysql_reporte_data:
  mysql_inventario_data:
